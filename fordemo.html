<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
	<title>单元格之合并及拆分</title>
	<!-- External CSS -->
	<link href="http://lib.sinaapp.com/js/jquery-ui/1.9.2/themes/base/jquery-ui.css" rel="stylesheet">
	<link href="http://lib.sinaapp.com/js/jquery-ui/1.9.2/themes/base/jquery.ui.selectable.css" rel="stylesheet">
	<link rel="stylesheet" href="./awesome/css/font-awesome.min.css">
	<!-- In-document CSS -->
	<style>
		* {
			margin: 0;
			padding: 0;
		}
		body {
			background-color: #444444;
		}
		#t {
			background-color: #444444;
		}
		#t td.ui-selecting { background: #FECA40; }
		#t td.ui-selected  { background: #F39814; color: white; }
		#t td {
			position: relative;
			background-color: #222222;
			cursor: pointer;
			text-align: center;
		}

		#warehouse {
			background-color: #444444;
			cursor: pointer;
		}
		#warehouse td {
			height: 106px;
			width: 150px;
			background-color: #222222;
		}
		#feedback { font-size: 1.4em; }
		.del {
			display: none;
			position: absolute;
			top: 3px;
			right: 3px;
			z-index: 999;
			cursor: pointer;
		}
		.warehouseBtn {
			height: 50px;
			width: 307px;
			background-color: #222222;
			line-height: 50px;
			text-align: center;
			color: white;
			float: left;
			cursor: pointer;
		}
		.adWords {
			color: #222222;
			font-style: italic;
			font-size: x-large;
			line-height: 50px;
			text-align: center;
			cursor: pointer;
		}
	</style>

	<!-- External JavaScript -->
	<script src="http://lib.sinaapp.com/js/jquery/1.9.1/jquery-1.9.1.min.js"></script>
	<script src="http://lib.sinaapp.com/js/jquery-ui/1.9.2/jquery-ui.min.js"></script>

	<!-- In-document JavaScript -->
	<body>
		<div>
			<div class="warehouseBtn" id="btnMerge">点击合并单元格</div>
			<div class="adWords">Free DashBoard</div>
			<!-- <button class="handleBtn" id="btnSplit">拆分选中单元格</button> -->
		</div>
		<div style="clear: both;">
			<table id="warehouse" style="float: left;">
				<tr>
					<td name="drag1" ondrop="drop(event)" ondragover="allowDrop(event)">
						<img src="./img/1.png" draggable="true" ondragstart="drag(event)" id="drag1">
					</td>
					<td name="drag5" ondrop="drop(event)" ondragover="allowDrop(event)">
						<img src="./img/5.png" draggable="true" ondragstart="drag(event)" id="drag5">
					</td>
				</tr>
				<tr>
					<td name="drag2" ondrop="drop(event)" ondragover="allowDrop(event)">
						<img src="./img/2.png" draggable="true" ondragstart="drag(event)" id="drag2">	 
					</td>
					<td name="drag6" ondrop="drop(event)" ondragover="allowDrop(event)">
						<img src="./img/6.png" draggable="true" ondragstart="drag(event)" id="drag6">
					</td>
				</tr>
				<tr>
					<td name="drag3" ondrop="drop(event)" ondragover="allowDrop(event)">
						<img src="./img/3.png" draggable="true" ondragstart="drag(event)" id="drag3">	 
					</td>
					<td name="drag7" ondrop="drop(event)" ondragover="allowDrop(event)">
						<img src="./img/7.png" draggable="true" ondragstart="drag(event)" id="drag7">
					</td>
				</tr>
				<tr>
					<td name="drag4" ondrop="drop(event)" ondragover="allowDrop(event)">
						<img src="./img/4.png" draggable="true" ondragstart="drag(event)" id="drag4">	 
					</td>
					<td name="drag8" ondrop="drop(event)" ondragover="allowDrop(event)">
						<img src="./img/8.png" draggable="true" ondragstart="drag(event)" id="drag8">
					</td>
				</tr>
				<tr>
					<td></td>
					<td></td>
				</tr>
				<tr>
					<td></td>
					<td></td>
				</tr>
			</table>

			<table id="t" class="ui-selectable" style="float: left;">
			</table>
		</div>
		
	</body>
	<script>
		
			//页面自动加载table中的标签
			var warehouseWidth = parseInt($('#warehouse').css('width'))+20;
			console.log(warehouseWidth);
			var bodyHeight = $(window).height(), bodyWidth = $(window).width()-warehouseWidth;
			var itemWidth = 50, itemHeight = 50; //每个单元格的尺寸
			var NumC = Math.floor( bodyWidth/itemWidth );	//一行有多少列
			var NumR = Math.floor( bodyHeight/itemHeight );	//一共要有多少行
			var itemBox = $("#t");
			itemBox.css({
				width: bodyWidth+"px",
				height: bodyHeight+"px"
			})
			for(var i=0;i<NumR;i++)
			{
				var tr=$("<tr></tr>");
				tr.appendTo(itemBox);
				for(var j=0;j<NumC;j++)
				{
					var td=$('<td style="width:'+itemWidth+'px;height:'+itemHeight+'px;" ondrop="drop(event)" ondragover="allowDrop(event)" class="ui-selectee"><i class="fa fa-times-circle-o del"></i></td>');
					td.appendTo(tr);
				}
			}
		//------合并单元格------
		$(function(){
			// 显示已选单元格编号
			// function ShowSelected()
			// {
			// 	var result = $("#select-result").empty();
			// 	var isEmpty = true;
			// 	var tds = $("th,td", $("#t")); //获取 #t 中的 td 元素
			// 	tds.filter(".ui-selected").each(function(){
			// 		result.append("#" + (tds.index(this) + 1) + " ");
			// 		isEmpty = false;
			// 	});
			// 	if (isEmpty) result.append("无");
			// }

			// 使表格可选
			$("#t").selectable();
			
			// 合并单元格按钮
			$("#btnMerge").click(function(){
				var $t = $("#t");
				
				if ($("table", $t).length > 0) {
					alert("不支持嵌套表格！");
					return;
				}
				
				var sigDel = "sign4delete";  // 删除标记，用作类名
				var sigSel = "ui-selected";  // 选中标记，用作类名
				
				// 补充单元格以便后继正确计算坐标
				$("th,td", $t).each(function(){
					// 坐标要实时计算，因会实时补充
					var ridx = $("tr", $t).index($(this).parent("tr"));	//行索引值
					var cidx = $(this).parent().children("th,td").index(this);	//列索引值
					var rowspan = Number($(this).attr("rowspan")) || 1; //获取当前td的 rowspan参数值
					var colspan = Number($(this).attr("colspan")) || 1; //获取当前td的 colspan参数值
					var isSel = $(this).hasClass(sigSel);
					// 非选单元格拆出的单元格要加删除标记
					
					if (rowspan <= 1 && colspan <= 1)
						return;
					// 跨格开插
					$("tr", $t).each(function(){
						var idx = $("tr", $t).index(this); 
						var arr, $td = $("<td>").addClass(isSel ? sigSel : sigDel);
						
						if (idx == ridx) {
							// 本行在 [cidx] 后插入 colspan-1 个
							
							arr = $();  // 准备待插单元格
							for (var i=0; i < colspan-1; i++)
								arr = arr.add($td.clone());
							// 插入
							$("th,td", this).eq(cidx).after(arr);
							
						} else if (ridx < idx && idx < ridx + rowspan) {
							// 以下行在 [cidx] 前插入 colspan 个
							
							arr = $();  // 准备待插单元格
							for (var i=0; i < colspan; i++)
								arr = arr.add($td.clone());
							// 插入
							if (cidx > 0 && $("th,td", this).eq(cidx - 1).length > 0)
								$("th,td", this).eq(cidx - 1).after(arr);
							else if ($("th,td", this).eq(cidx).length > 0)
								$("th,td", this).eq(cidx).before(arr);
							else
								$(this).prepend(arr);
						}
					});
				});
				
				var rmin = 10000, cmin = 10000;
				var rmax = 0    , cmax = 0    ;
				var rnum        , cnum        ;
				// 计算起始和跨距
				$("th,td", $t).filter("." + sigSel).each(function(){
					var ridx = $("tr", $t).index($(this).parent("tr"));
					rmin = ridx < rmin ? ridx : rmin;
					rmax = ridx > rmax ? ridx : rmax;
					var cidx = $(this).parent().children("th,td").index(this);
					cmin = cidx < cmin ? cidx : cmin;
					cmax = cidx > cmax ? cidx : cmax;
				});
				rnum = rmax - rmin + 1;
				cnum = cmax - cmin + 1;
				
				// 合并单元格
				$("th,td", $t).each(function(){
					var ridx = $("tr", $t).index($(this).parent("tr"));
					var cidx = $(this).parent().children("th,td").index(this);
					// 标记单元格待删
					if (rmin <= ridx && ridx <= rmax
						&& cmin <= cidx && cidx <= cmax)
						$(this).addClass(sigDel);
					// 处理被选左上角单元格
					if (ridx == rmin && cidx == cmin)
						$(this).removeClass(sigDel).attr({rowspan: rnum, colspan: cnum});
					// 清理残余
					if ($(this).attr("rowspan") == 1) $(this).removeAttr("rowspan");
					if ($(this).attr("colspan") == 1) $(this).removeAttr("colspan");
				}).remove("." + sigDel);
				// 移除标记单元格
				
				//ShowSelected();  // 更新选择结果文字
			});
			
			// 拆分单元格按钮
			$("#btnSplit").click(function(){
				var $t = $("#t");

				if ($("table", $t).length > 0) {
					alert("不支持嵌套表格！");
					return;
				}

				var sigDel = "sign4delete";  // 删除标记，类名，自定义
				var sigSel = "ui-selected";  // 选中标记，类名，jQuery UI 定义

				// 补充单元格以便后继正确计算坐标
				$("th,td", $t).each(function(){
					// 坐标要实时计算，因会实时补充
					var ridx = $("tr", $t).index($(this).parent("tr"));
					var cidx = $(this).parent().children("th,td").index(this);
					var rowspan = Number($(this).attr("rowspan")) || 1;
					var colspan = Number($(this).attr("colspan")) || 1;
					var isSel = $(this).hasClass(sigSel);
					// 非选单元格拆出的单元格要加删除标记

					if (rowspan <= 1 && colspan <= 1)
						return;

					if (isSel)
						$(this).removeAttr("colspan").removeAttr("rowspan");

					// 跨格开插
					$("tr", $t).each(function(){
						var idx = $("tr", $t).index(this);
						var arr, $td = $("<td>");

						if (!isSel)
							$td.addClass(sigDel);

						if (idx == ridx) {
							// 本行在 [cidx] 后插入 colspan-1 个

							arr = $();  // 准备待插单元格
							for (var i=0; i < colspan-1; i++)
								arr = arr.add($td.clone());

							$("th,td", this).eq(cidx).after(arr);

						} else if (ridx < idx && idx < ridx + rowspan) {
							// 以下行在 [cidx] 前插入 colspan 个

							arr = $();  // 准备待插单元格
							for (var i=0; i < colspan; i++)
								arr = arr.add($td.clone());

							if (cidx > 0 && $("th,td", this).eq(cidx - 1).length > 0)
								$("th,td", this).eq(cidx - 1).after(arr);
							else if ($("th,td", this).eq(cidx).length > 0)
								$("th,td", this).eq(cidx).before(arr);
							else
								$(this).prepend(arr);
						}
					});
				});

				// 重新获取以取到删者并删之
				$("th,td", $t).remove("." + sigDel);
				ShowSelected();  // 更新选择结果文字
			});
		});

		//------H5拖拽事件------
		function allowDrop(ev)
		{
			ev.preventDefault();	
		}

		function drag(ev)
		{
			ev.dataTransfer.setData("Text",ev.target.id);
		}

		function drop(ev)
		{
			if(ev.target.id){
				console.log("已有元素，不可再拖入")
				return false;
			}else{
				ev.preventDefault();
				var data=ev.dataTransfer.getData("Text");
				ev.target.appendChild(document.getElementById(data));
			}
		}

		//------鼠标悬停出现按钮，删除当前项------
		$("th,td", $("#t")).hover(function() {
			if( $(this).find('img').length >0 ){
				$(this).find('i').css('display', 'block');
			}
		},function() {
			$(this).find('i').css('display', 'none');
		})

		//------点击清空单元格中的标签,并将之放回到原来的盒子里------
		$(".fa", $("#t")).click(function(){
			var dragDom = $(this).next();	 //获取我们拖动过去的那个标签，也是即将删除的标签
			var boxDom = dragDom.attr('id');	//元素盒子的name值和元素的id值相同
			$(this).css('display', 'none');	//将小叉号隐藏，不然点击完之后只要鼠标还在，叉号就不消失，看着很奇怪
			var copyCurrent = dragDom.prop("outerHTML");
			$("[name="+boxDom+"]").html(copyCurrent);
			dragDom.remove();	//删除标签，但右上角的小图标还在，因为我们还要用
		})

	</script>
</head>
</html>
